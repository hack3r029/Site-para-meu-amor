<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Para Guilherme ‚ù§Ô∏è</title>

  <!-- ======== SENHA ======== -->
  <style>
    #senhaTela {
      position: fixed;
      inset: 0;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      z-index: 99999;
      font-family: Arial, sans-serif;
    }
    #senhaTela h2 { font-size: 22px; margin-bottom: 10px; }
    #senhaTela input {
      padding: 10px; font-size: 18px; border: 2px solid #ccc;
      border-radius: 8px; width: 200px; text-align: center; margin-bottom: 10px;
    }
    #senhaTela button {
      background: #ff6aa0; color: white; font-size: 16px;
      padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
    }
    #senhaErro { color: red; margin-top: 10px; font-size: 14px; }
  </style>

  <div id="senhaTela">
    <h2>Digite a senha para acessar ‚ù§Ô∏è</h2>
    <input type="password" id="senhaInput" placeholder="Senha">
    <button onclick="verificarSenha()">Entrar</button>
    <div id="senhaErro"></div>
  </div>

  <script>
    const senhaCorreta = "MYLOVE5";
    function verificarSenha() {
      const entrada = document.getElementById("senhaInput").value;
      if (entrada === senhaCorreta) {
        document.getElementById("senhaTela").style.display = "none";
      } else {
        document.getElementById("senhaErro").innerText = "Senha incorreta üíî";
      }
    }
  </script>
  <!-- ======== FIM SENHA ======== -->

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1: #fff8fb;
      --bg2: #fff0f6;
      --accent: #ff6b9a;
      --muted: #6b6b6b;
      --card: rgba(255,255,255,0.8);
    }
    body{
      font-family: 'Montserrat', sans-serif; margin:0;
      background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:#222;
    }
    .container{max-width:960px;margin:32px auto;padding:20px}

    .card{
      background:var(--card);backdrop-filter: blur(6px);
      border-radius:14px;padding:18px;margin-bottom:20px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06)
    }

    .btn{
      display:inline-block;padding:10px 14px;border-radius:12px;
      background:linear-gradient(90deg,var(--accent),#ff88ac);
      color:#fff;text-decoration:none;font-weight:600;
      border:none;cursor:pointer;
    }
    
    .msg {
      padding:10px;border-radius:8px;border:1px solid #fde8f1;
      margin-bottom:10px;background:#fff;position:relative;
    }
    .msg .deleteBtn{
      position:absolute;right:10px;top:10px;
      background:#ff6b9a;color:#fff;border:none;
      padding:4px 8px;border-radius:4px;font-size:12px;
      cursor:pointer;
    }
    audio{ width:100%; margin-top:6px; }
  </style>
</head>

<body>
  <div class="container">

    <section class="card">
      <h2>Deixe uma mensagem üíï</h2>
      <form id="noteForm" onsubmit="saveNote(event)">
        <input id="noteName" type="text" placeholder="Seu nome" required
          style="width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #f0dbe2">

        <textarea id="noteText" rows="3" placeholder="Escreva algo doce..."
          style="width:100%;padding:10px;border-radius:8px;border:1px solid #f0dbe2;resize:vertical"></textarea>

        <button class="btn" type="submit" style="margin-top:10px;width:100%">
          Enviar mensagem ‚ù§Ô∏è
        </button>
      </form>

      <!-- GRAVA√á√ÉO DE √ÅUDIO -->
      <div style="margin-top:15px">
        <h3>Gravar √°udio üé§</h3>
        <button id="recordBtn" class="btn" onclick="toggleRecord()">
          üé§ Iniciar grava√ß√£o
        </button>
        <p id="recordStatus" style="color:var(--muted);margin-top:8px;"></p>
      </div>

      <div id="notesArea" style="margin-top:20px">
        <em>Carregando mensagens...</em>
      </div>
    </section>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, doc,
      query, orderBy, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB1YSEkJdFC2woR-1O-h-C_-hMWrMhJzNU",
      authDomain: "mensagens-guilherme.firebaseapp.com",
      projectId: "mensagens-guilherme",
      storageBucket: "mensagens-guilherme.firebasestorage.app",
      messagingSenderId: "708631649836",
      appId: "1:708631649836:web:80337bce5195d511cd7b89"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const msgsCol = collection(db, "mensagens");

    // Salvar texto
    async function saveNoteOnline(name, text){
      await addDoc(msgsCol, {
        nome: name,
        texto: text || null,
        audio: null,
        timestamp: Date.now(),
        data: new Date().toLocaleString()
      });
    }

    // Salvar √°udio
    async function saveAudioOnline(name, audioBlob){
      const filename = `audios/audio_${Date.now()}.webm`;
      const storageRef = ref(storage, filename);
      await uploadBytes(storageRef, audioBlob);
      const downloadURL = await getDownloadURL(storageRef);

      await addDoc(msgsCol, {
        nome: name,
        texto: null,
        audio: downloadURL,
        timestamp: Date.now(),
        data: new Date().toLocaleString()
      });
    }

    // Excluir mensagem
    window.deleteMessage = async function(id){
      if(confirm("Tem certeza que deseja excluir esta mensagem?")){
        await deleteDoc(doc(db, "mensagens", id));
      }
    };

    // Listener
    const q = query(msgsCol, orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
      const area = document.getElementById("notesArea");
      if(snapshot.empty){
        area.innerHTML = "<em>Nenhuma mensagem ainda.</em>";
        return;
      }

      let html = "";
      snapshot.forEach(docu => {
        const d = docu.data();
        html += `
          <div class="msg">
            <button class="deleteBtn" onclick="deleteMessage('${docu.id}')">Excluir</button>
            <div class="meta"><strong>${d.nome}</strong> ‚Äî ${d.data}</div>

            ${d.texto ? `<p style="margin-top:6px">${d.texto}</p>` : ""}

            ${d.audio ? `<audio controls src="${d.audio}"></audio>` : ""}
          </div>
        `;
      });

      area.innerHTML = html;
    });

    // Enviar texto
    window.saveNote = async function(e){
      e.preventDefault();
      const name = document.getElementById("noteName").value.trim();
      const text = document.getElementById("noteText").value.trim();
      if(!name) return alert("Escreva seu nome üíï");
      if(!text) return alert("Escreva sua mensagem üíï");

      await saveNoteOnline(name, text);
      document.getElementById("noteText").value = "";
    };

    // GRAVA√á√ÉO DE √ÅUDIO
    let recorder, chunks = [], recording = false;

    window.toggleRecord = async function(){
      const status = document.getElementById("recordStatus");
      const btn = document.getElementById("recordBtn");

      if(!recording){
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        recorder = new MediaRecorder(stream);

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = async () => {
          const blob = new Blob(chunks, { type: "audio/webm" });
          chunks = [];

          const name = prompt("Seu nome para enviar o √°udio:");
          if(name){
            await saveAudioOnline(name, blob);
            status.innerHTML = "√Åudio enviado com sucesso! ‚ù§Ô∏è";
          }
        };

        recorder.start();
        recording = true;
        btn.innerText = "‚èπ Parar grava√ß√£o";
        status.innerText = "Gravando √°udio...";
      }
      else{
        recorder.stop();
        recording = false;
        btn.innerText = "üé§ Iniciar grava√ß√£o";
        status.innerText = "";
      }
    };

  </script>

</body>
</html>
